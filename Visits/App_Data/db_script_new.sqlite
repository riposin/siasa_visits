PRAGMA encoding = "UTF-8"; 
.open visits.db



 -- -- -- -- TABLES -- -- -- --

CREATE TABLE preregistrations(
	guid BLOB(16) NOT NULL PRIMARY KEY,
	company_key NVARCHAR(20) NOT NULL,
	full_name NVARCHAR(100) NOT NULL,
	email NVARCHAR(100) NOT NULL,
	visit_date DATETIME NOT NULL,
	motive NVARCHAR(150),
	created_at DATETIME NOT NULL,
	confirmed_at DATETIME
);

CREATE TABLE preregistrations_settings(
	id INTEGER PRIMARY KEY,
	link_expiration_hours SMALLINT NOT NULL,
	link_url_format NVARCHAR(200) NOT NULL,
	email_subject NVARCHAR(100) NOT NULL,
	email_body_format NVARCHAR(700) NOT NULL,
	email_date_time_format NVARCHAR(50) NOT NULL,
	smtp_host NVARCHAR(50) NOT NULL,
	smtp_port SMALLINT NOT NULL,
	smtp_user NVARCHAR(50) NOT NULL,
	smtp_password NVARCHAR(100) NOT NULL,
	lang_locale_default NVARCHAR(100) NOT NULL,
	lang_labels_version INTEGER NOT NULL
);

CREATE TABLE locales(
	id NVARCHAR(5) PRIMARY KEY,
	name NVARCHAR(50) NOT NULL,
	selector_id NVARCHAR(5) NOT NULL,
	selector_name NVARCHAR(50) NOT NULL,
	date_time_format NVARCHAR(25) NOT NULL
);

CREATE TABLE labels(
	id INTEGER PRIMARY KEY,
	locale_id NVARCHAR(5) NOT NULL,
	label NVARCHAR(40) NOT NULL,
	translation NVARCHAR(300) NOT NULL,
	FOREIGN KEY(locale_id) REFERENCES locales(id),
	UNIQUE(locale_id, label)
);



-- -- -- -- DEFAULT CONFIG -- -- -- --

INSERT INTO preregistrations_settings(id, link_expiration_hours, link_url_format, email_subject, email_body_format, email_date_time_format, smtp_host, smtp_port, smtp_user, smtp_password, lang_locale_default, lang_labels_version) VALUES(NULL, 0, '', '','', '', '', 0, '', '', '', 0);

UPDATE preregistrations_settings SET link_expiration_hours = 	24;
UPDATE preregistrations_settings SET link_url_format = 			'Confirmation/Show/{0}';
UPDATE preregistrations_settings SET email_subject = 			'Solicitud de confirmaci&oacute;n de Visita';
UPDATE preregistrations_settings SET email_body_format = 		'<p>Clave de empresa: <span style="font-weight: bold;">{0}</span><br/>Nombre completo: <span style="font-weight: bold;">{1}</span><br/>Fecha y hora: <span style="font-weight: bold;">{2}</span><br/>Motivo: <span style="font-weight: bold;">{3}</span><br/><a href="{4}">Confirmar el pre-registro</a><br/><br/><span style="font-weight: bold;"><a href="{4}">{4}</a></span></p>';
UPDATE preregistrations_settings SET email_date_time_format = 	'dd/MM/yyyy hh:mm tt';
UPDATE preregistrations_settings SET lang_locale_default =		'es-MX';
UPDATE preregistrations_settings SET lang_labels_version =		1;
UPDATE preregistrations_settings SET smtp_host = 				'smtp.gmail.com';
UPDATE preregistrations_settings SET smtp_port = 				'587';
UPDATE preregistrations_settings SET smtp_user = 				'cortana@gmail.com';
UPDATE preregistrations_settings SET smtp_password = 			'spartan117';



-- -- -- -- LABELS -- -- -- --

INSERT INTO locales(id, name, selector_id, selector_name, date_time_format) VALUES('es-MX', 'Spanish (M&eacute;xico)', 'ES', 'Espa&ntilde;ol',	'DD-MM-YYYY hh:mm A');
INSERT INTO locales(id, name, selector_id, selector_name, date_time_format) VALUES('en-US', 'English (United States)', 'US', 'English', 		'MM-DD-YYYY hh:mm A');

-- Labels for es-MX
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'LBL_VISITS',				'visitas');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'LBL_SCR_TITLE_REQ',		'solicitud de pre-registro de visitantes');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'LBL_COMP_KEY',				'clave de empresa');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'LBL_FNAME',				'nombre completo');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'LBL_EMAIL',				'correo electr&oacute;nico');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'LBL_DATETIME',				'fecha y hora');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'LBL_VMOTIVE',				'motivo de visita');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'LBL_SEND_EMAIL_PREREQ',	'enviar correo para iniciar el pre-registro');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'LBL_PROC_PLEASE_WAIT',		'procesando, espere un momento por favor');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'LBL_CAPTURE_QR', 			'captura el c&oacute;digo captcha');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'LBL_FOOT_COPYRIGHT', 		'Derechos Reservados 2024 &copy; SIASA | Sistemas Integrales de Automatizaci&oacute;n S.A. de C.V.');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'LBL_FOOT_CONTACT', 		'marketing@siasa.com | SIASA Matriz: (999) 930.2575 | SIASA CDMX: (55) 5264.2272 | SIASA Latam: (305) 479.2303');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'LBL_PTITLE_SUFFIX', 		' - Visitas SIASA');
-- INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'LBL_', '');

-- Labels for en-US
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'LBL_VISITS',				'visits');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'LBL_SCR_TITLE_REQ',		'visitor pre-registration request');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'LBL_COMP_KEY',				'company key');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'LBL_FNAME',				'full name');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'LBL_EMAIL',				'email');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'LBL_DATETIME',				'date and time');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'LBL_VMOTIVE',				'visit motive');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'LBL_SEND_EMAIL_PREREQ',	'send email to start pre-registration');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'LBL_PROC_PLEASE_WAIT',		'processing, please wait');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'LBL_CAPTURE_QR', 			'capture the captcha code');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'LBL_FOOT_COPYRIGHT', 		'All Rights Reserved 2024 &copy; SIASA | Sistemas Integrales de Automatizaci&oacute;n S.A. de C.V.');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'LBL_FOOT_CONTACT', 		'marketing@siasa.com | SIASA Headquarters: (999) 930.2575 | SIASA CDMX: (55) 5264.2272 | SIASA Latin America: (305) 479.2303');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'LBL_PTITLE_SUFFIX', 		' - Visits SIASA');
-- INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'LBL_', '');



-- -- -- -- TRIGGERS -- -- -- --

CREATE TRIGGER setEmptyToNullConfirmDate
	AFTER INSERT
	ON preregistrations
	WHEN trim(new.confirmed_at) IS ''
BEGIN
	UPDATE preregistrations
		SET confirmed_at = NULL
	WHERE rowid = NEW.rowid;
END;

CREATE TRIGGER changeEmptyToNullConfirmDate
	AFTER UPDATE
	ON preregistrations
	WHEN trim(new.confirmed_at) IS ''
BEGIN
	UPDATE preregistrations
		SET confirmed_at = NULL
	WHERE rowid = NEW.rowid;
END;



.quit

