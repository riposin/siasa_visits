PRAGMA encoding = "UTF-8"; 
.open visits.db



 -- -- -- -- TABLES -- -- -- --

CREATE TABLE preregistrations(
	guid BLOB(16) NOT NULL PRIMARY KEY,
	company_key NVARCHAR(20) NOT NULL,
	full_name NVARCHAR(100) NOT NULL,
	email NVARCHAR(100) NOT NULL,
	visit_date DATETIME NOT NULL,
	motive NVARCHAR(150),
	created_at DATETIME NOT NULL,
	confirmed_at DATETIME
);

CREATE TABLE preregistrations_settings(
	id INTEGER PRIMARY KEY,
	link_expiration_hours SMALLINT NOT NULL,
	link_url_format NVARCHAR(200) NOT NULL,
	email_subject NVARCHAR(100) NOT NULL,
	email_body_format NVARCHAR(700) NOT NULL,
	email_date_time_format NVARCHAR(50) NOT NULL,
	smtp_host NVARCHAR(50) NOT NULL,
	smtp_port SMALLINT NOT NULL,
	smtp_user NVARCHAR(50) NOT NULL,
	smtp_password NVARCHAR(100) NOT NULL,
	lang_locale_default NVARCHAR(100) NOT NULL,
	lang_labels_version INTEGER NOT NULL
);

CREATE TABLE locales(
	id NVARCHAR(5) PRIMARY KEY,
	name NVARCHAR(50) NOT NULL,
	selector_id NVARCHAR(5) NOT NULL,
	selector_name NVARCHAR(50) NOT NULL,
	date_time_format NVARCHAR(25) NOT NULL
);

CREATE TABLE labels(
	id INTEGER PRIMARY KEY,
	locale_id NVARCHAR(5) NOT NULL,
	label NVARCHAR(40) NOT NULL,
	translation NVARCHAR(300) NOT NULL,
	FOREIGN KEY(locale_id) REFERENCES locales(id),
	UNIQUE(locale_id, label)
);



-- -- -- -- DEFAULT CONFIG -- -- -- --

INSERT INTO preregistrations_settings(id, link_expiration_hours, link_url_format, email_subject, email_body_format, email_date_time_format, smtp_host, smtp_port, smtp_user, smtp_password, lang_locale_default, lang_labels_version) VALUES(NULL, 0, '', '','', '', '', 0, '', '', '', 0);

UPDATE preregistrations_settings SET link_expiration_hours = 	24;
UPDATE preregistrations_settings SET link_url_format = 			'Confirmation/Show/{0}';
UPDATE preregistrations_settings SET email_subject = 			'Solicitud de confirmaci&oacute;n de Visita';
UPDATE preregistrations_settings SET email_body_format = 		'<p>Clave de empresa: <span style="font-weight: bold;">{0}</span><br/>Nombre completo: <span style="font-weight: bold;">{1}</span><br/>Fecha y hora: <span style="font-weight: bold;">{2}</span><br/>Motivo: <span style="font-weight: bold;">{3}</span><br/><a href="{4}">Confirmar el pre-registro</a><br/><br/><span style="font-weight: bold;"><a href="{4}">{4}</a></span></p>';
UPDATE preregistrations_settings SET email_date_time_format = 	'dd/MM/yyyy hh:mm tt';
UPDATE preregistrations_settings SET lang_locale_default =		'es-MX';
UPDATE preregistrations_settings SET lang_labels_version =		1;
UPDATE preregistrations_settings SET smtp_host = 				'smtp.gmail.com';
UPDATE preregistrations_settings SET smtp_port = 				'587';
UPDATE preregistrations_settings SET smtp_user = 				'cortana@gmail.com';
UPDATE preregistrations_settings SET smtp_password = 			'spartan117';



-- -- -- -- LABELS -- -- -- --

INSERT INTO locales(id, name, selector_id, selector_name, date_time_format) VALUES('es-MX', 'Spanish (M&eacute;xico)', 'ES', 'Espa&ntilde;ol',	'DD-MM-YYYY hh:mm A');
INSERT INTO locales(id, name, selector_id, selector_name, date_time_format) VALUES('en-US', 'English (United States)', 'US', 'English', 		'MM-DD-YYYY hh:mm A');

-- Labels for es-MX
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'FOT_COPYRIGHT', 			'Derechos Reservados 2024 &copy; SIASA | Sistemas Integrales de Automatizaci&oacute;n S.A. de C.V.');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'FOT_CONTACT',		 		'marketing@siasa.com | SIASA Matriz: (999) 930.2575 | SIASA CDMX: (55) 5264.2272 | SIASA Latam: (305) 479.2303');

INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'TTL_SCR_SUFFIX', 			' - Visitas SIASA');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'TTL_SCR_REQPRE',			'solicitud de pre-registro de visitantes');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'TTL_SCR_CONFIRM',			'confirmaci&oacute;n de visita');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'TTL_SCR_CONFIRMED',		'visita confirmada');

INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'TTL_TAKESC_PRINTQR',		'Tome captura o descargue e imprima el QR');

INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'QST_ISALLDATAOK', 			'¿Los datos proporcionados son correctos?');

INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'MSG_PROC_PLEASE_WAIT',		'procesando, espere un momento por favor');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'MSG_REQ_PREREG_OK',		'La solicitud se realiz&oacute; de forma correcta. Se ha enviado un correo a la direcci&oacute;n proporcionada para continuar con el proceso de pre-registro.');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'MSG_REQ_PREREG_ERR',		'La solicitud de pre-registro no se realiz&oacute; de forma exitosa, por favor reintente.');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'MSG_REQ_FIELD',			'Este campo es requerido');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'MSG_CAPTURECAPTCHA',		'Captura el c&oacute;digo de 4 d&iacute;gitos (Captcha) en la caja de texto');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'MSG_VCONFIRMED',			'La visita ya fu&eacute; confirmada, use el botón de abajo para ver el c&oacute;digo QR.');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'MSG_VARRIVE_EARLY',		'Favor de presentarse antes de la hora programada para su visita.');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'MSG_QRONHAND',				'Importante acuda a su visita teniendo a la mano el QR.');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'MSG_INVALID_LINK',			'El enlace no es v&aacute;lido.');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'MSG_VDATE_EXPIRED',		'La fecha de la visita ya ha pasado.');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'MSG_VLINK_EXPIRED',		'El enlace de confirmaci&oacute;n ha dejado de estar vigente.');

INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'LBL_VISITS',				'visitas');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'LBL_COMP_KEY',				'clave de empresa');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'LBL_FNAME',				'nombre completo');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'LBL_EMAIL',				'correo electr&oacute;nico');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'LBL_DATETIME',				'fecha y hora');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'LBL_VMOTIVE',				'motivo de visita');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'LBL_SEND_EMAIL_PREREQ',	'enviar correo para iniciar el pre-registro');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'LBL_CONFIRMATION', 		'confirmaci&oacute;n');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'LBL_YES',			 		'si');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'LBL_NO',					'no');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'LBL_SUCCESS',				'&eacute;xito');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'LBL_OK',					'aceptar');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'LBL_ERROR',				'error');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'LBL_CAPTCHA',				'Captcha');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'LBL_SHOW',					'Mostrar');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'LBL_CONFIRM_VISIT',		'Confirmar visita');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'LBL_PRINT',				'imprimir');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'LBL_DOWNLOAD',				'descargar');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'LBL_CLOSE',				'cerrar');
-- INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'es-MX', 'LBL_',	'');


-- Labels for en-US
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'FOT_COPYRIGHT', 			'All Rights Reserved 2024 &copy; SIASA | Sistemas Integrales de Automatizaci&oacute;n S.A. de C.V.');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'FOT_CONTACT', 				'marketing@siasa.com | SIASA Headquarters: (999) 930.2575 | SIASA CDMX: (55) 5264.2272 | SIASA Latin America: (305) 479.2303');

INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'TTL_SCR_SUFFIX', 			' - Visits SIASA');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'TTL_SCR_REQPRE',			'visitor pre-registration request');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'TTL_SCR_CONFIRM',			'visit confirmation');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'TTL_SCR_CONFIRMED',		'visit confirmed');

INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'TTL_TAKESC_PRINTQR',		'Take screenshot or download and print the QR');

INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'QST_ISALLDATAOK', 			'Is the data provided correct?');

INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'MSG_PROC_PLEASE_WAIT',		'processing, please wait');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'MSG_REQ_PREREG_OK',		'The request was made correctly. An email has been sent to the address provided to continue with the pre-registration process.');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'MSG_REQ_PREREG_ERR',		'The pre-registration request was not successful, please retry.');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'MSG_REQ_FIELD',			'This field is required');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'MSG_CAPTURECAPTCHA',		'Capture the 4-digit code (Captcha) in the text box');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'MSG_VCONFIRMED',			'The visit has already been confirmed, use the button below to view the QR code.');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'MSG_VARRIVE_EARLY',		'Please arrive before your scheduled visit time.');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'MSG_QRONHAND',				'It is important to come to your visit with the QR at hand.');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'MSG_INVALID_LINK',			'The link is not valid.');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'MSG_VDATE_EXPIRED',		'The visit date has already passed.');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'MSG_VLINK_EXPIRED',		'The confirmation link has expired.');

INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'LBL_VISITS',				'visits');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'LBL_COMP_KEY',				'company key');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'LBL_FNAME',				'full name');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'LBL_EMAIL',				'email');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'LBL_DATETIME',				'date and time');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'LBL_VMOTIVE',				'visit motive');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'LBL_SEND_EMAIL_PREREQ',	'send email to start pre-registration');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'LBL_CONFIRMATION', 		'confirm');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'LBL_YES',					'yes');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'LBL_NO',					'no');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'LBL_SUCCESS',				'sucess');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'LBL_OK',					'ok');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'LBL_ERROR',				'error');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'LBL_CAPTCHA',				'Captcha');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'LBL_SHOW',					'Show');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'LBL_CONFIRM_VISIT',		'Confirm visit');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'LBL_PRINT',				'print');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'LBL_DOWNLOAD',				'download');
INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'LBL_CLOSE',				'close');
-- INSERT INTO labels(id, locale_id, label, translation) VALUES(NULL, 'en-US', 'LBL_',	'');



-- -- -- -- TRIGGERS -- -- -- --

CREATE TRIGGER setEmptyToNullConfirmDate
	AFTER INSERT
	ON preregistrations
	WHEN trim(new.confirmed_at) IS ''
BEGIN
	UPDATE preregistrations
		SET confirmed_at = NULL
	WHERE rowid = NEW.rowid;
END;

CREATE TRIGGER changeEmptyToNullConfirmDate
	AFTER UPDATE
	ON preregistrations
	WHEN trim(new.confirmed_at) IS ''
BEGIN
	UPDATE preregistrations
		SET confirmed_at = NULL
	WHERE rowid = NEW.rowid;
END;



.quit

