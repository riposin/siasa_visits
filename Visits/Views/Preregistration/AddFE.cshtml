@*
	||||| THIS VIEW IMPLEMENTS CAPTCHA IN THE SIMPLE WAY, GENERATION AND VALIDATION IN THE FE SIDE |||||
*@
@using BotDetect.Web.Mvc
@model Visits.Models.ViewModels.PreregistrationsViewModel
@{
	ViewBag.Title = "Solicitud de pre-registro";
}
@section content{
	@Styles.Render(@BotDetect.Web.CaptchaUrls.Absolute.LayoutStyleSheetUrl)
	@Styles.Render("/Content/bootstrap-datetimepicker.css")
}

<h2 class="text-center">Solicitud de pre-registro</h2>
<div class="row">
	<div class="col-md-6 col-md-offset-3">

		@using (Html.BeginForm("AddFE", "Preregistration", FormMethod.Post, new { role = "from", @class = "", id = "preregistration" }))
		{
			@Html.AntiForgeryToken()

			@Html.LabelFor(d => d.CompanyKey)
			@Html.TextBoxFor(d => d.CompanyKey, new { @class = "form-control", title = "Clave de la empresa" })
			@Html.ValidationMessage("CompanyKey", new { @class = "text-danger" })<br /><br />

			@Html.LabelFor(d => d.FullName)
			@Html.TextBoxFor(d => d.FullName, new { @class = "form-control", title = "Nombre completo del visitante" })
			@Html.ValidationMessage("FullName", new { @class = "text-danger" })<br /><br />

			@Html.LabelFor(d => d.Email)
			@Html.TextBoxFor(d => d.Email, new { @class = "form-control", title = "Correo electrónico del visitante" })
			@Html.ValidationMessage("Email", new { @class = "text-danger" })<br /><br />

			<div class="form-group">
				<label for="VisitDateMask">Fecha y Hora</label>
				<div class='input-group date' id='visitDTP'>
					<input type='text' class="form-control" id="VisitDateMask" />
					<span class="input-group-addon">
						<span class="glyphicon glyphicon-calendar"></span>
					</span>
				</div>
				@Html.ValidationMessage("VisitDate", new { @class = "text-danger" })<br /><br />
				@if (Model == null)
				{
					@Html.Hidden("VisitDate", "")
				}
				else
				{
					@Html.Hidden("VisitDate", Model.VisitDate)
				}
			</div>

			@Html.LabelFor(d => d.Motive)
			@Html.TextBoxFor(d => d.Motive, new { @class = "form-control", title = "Motivo de la visita" })
			@Html.ValidationMessage("Motive", new { @class = "text-danger" })<br /><br />

			<div class="text-center">
				<div style="display:inline-block;">
					<div id="Captcha" data-captchastylename="CaptchaStyle"></div>
				</div>
			</div>
			<input id="CaptchaCode" name="CaptchaCode" type="text" class="form-control" , title="Captura el código captcha" />
			@Html.ValidationMessage("CaptchaCode", new { @class = "text-danger" })
			@Html.Hidden("CaptchaId", "")

			<div class="text-center">
				<input type="submit" class="btn btn-success" value="Enviar correo para iniciar el pre-registro" title="Enviar correo para iniciar el pre-registro" />
			</div>
		}
	</div>

</div>

<!-- Modal -->
<div class="modal fade" id="confirmDialog" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-sm">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				<h4 class="modal-title" id="myModalLabel">Confirmación</h4>
			</div>
			<div class="modal-body">
				¿Los datos proporcionados son correctos?
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">No</button>
				<button type="button" class="btn btn-primary" id="confirmButton">Si</button>
			</div>
		</div><!-- /.modal-content -->
	</div><!-- /.modal-dialog -->
</div><!-- /.modal -->

@section scripts {
	@Scripts.Render("~/Scripts/moment.min.js")
	@Scripts.Render("~/locales/moment/es-mx.js")
	@Scripts.Render("~/Scripts/bootstrap-datetimepicker.min.js")
	@Scripts.Render("~/Scripts/jquery-captcha.min.js")

	<script type="text/javascript">
		/* VISIT DTP */
		//let dtFormat = 'MM-DD-YYYY hh:mm A'; // en-US
		let dtFormat = 'DD-MM-YYYY hh:mm A'; // es-MX
		let visitDateMaskID = 'VisitDateMask';
		let visitDateID = 'VisitDate';
		let confirmDialogID = '#confirmDialog';
		let isDataConfirmed = false;
		let captcha;

		$(function () {
			$('#visitDTP').datetimepicker({
				format: dtFormat,
				minDate: Date.now()
			});

			let visitDT = document.getElementById(visitDateID).value;
			if (visitDT.length > 0 && moment(visitDT).isValid()) {
				let visitMoment = moment(visitDT);
				document.getElementById(visitDateMaskID).value = visitMoment.format(dtFormat);
			}


			captcha = $('#Captcha').captcha({
				captchaEndpoint: '/simple-captcha-endpoint.ashx'
			});

		});


		document.getElementById("CaptchaCode").value = '';
		document.getElementById("preregistration").addEventListener("submit", onFormSubmit);
		function onFormSubmit(event) {

			// Visit DateTimePicker
			let visitDT = document.getElementById(visitDateMaskID).value;

			if (visitDT.length > 0 && moment(visitDT, dtFormat).isValid()) {
				let visitMoment = moment(visitDT, dtFormat);
				document.getElementById(visitDateID).value = visitMoment.format();
			}

			// Send Data and CAPTCHA
			document.getElementById("CaptchaId").value = captcha.getCaptchaId();

			/*var postData = {
				CaptchaCode: captcha.getUserEnteredCaptchaCode(),
				captchaId: captcha.getCaptchaId()
			};*/
			const data = new URLSearchParams(new FormData(event.target)).toString()

			var fetch_status;
			fetch('/Preregistration/AddFE', {
				method: "POST",
				headers: {
					'Accept': 'application/json',
					'Content-Type': 'application/x-www-form-urlencoded'
				},
				body: data
			})
			.then(function (response) {
				fetch_status = response.status;
				return response.json();
			})
			.then(function (json) {
				alert(JSON.stringify(json));
				console.log(json);
				//captcha.reloadImage();
				if (fetch_status == 200) { }
			})
			.catch(function (error) {
				console.log(error);
				//captcha.reloadImage();
			});

			alert('antes de enviar form');
			event.preventDefault();
		}
	</script>
}